var
  mme, mme1, mme2 : float;
  adxVal, ifrVal, atvVal : float;
  min1, max1 : float;
  tr, trMedia : float;
  periodoATR : integer;

begin
  // -------- PrÃ©-cÃ¡lculos --------
  periodoATR := 14;
  mme        := MediaExp(9, Close);
  mme1       := MediaExp(9, Close)[1];
  mme2       := MediaExp(9, Close)[2];
  adxVal     := ADX(14, 7);
  ifrVal     := RSI(14, 0);
  min1       := Low[1];
  max1       := High[1];

  // -------- True Range e ATV --------
  tr := Max(
          High - Low,
          Max(abs(High - Close[1]), abs(Low - Close[1]))
        );
  atvVal  := Media(periodoATR, tr);
  trMedia := Media(periodoATR * 2, tr);

  // -------- Regras de coloraÃ§Ã£o --------
  // Verde â†’ sinal de compra
  // Vermelho â†’ sinal de venda
  // Amarelo â†’ alerta de stop

  if (adxVal >= 25) and (atvVal > trMedia) then
  begin
    // ReversÃ£o de ALTA (MME9 sobe)
    if (mme > mme1) and (mme1 < mme2) then
    begin
      PaintBar(clGreen);  // pinta candle verde
      Alert(clGreen);
      PlotText("âœ… MME9â†‘ + ADX forte + ATVâ†‘ â€” possÃ­vel compra", clGreen, 3, 6, Low);
    end;

    // ReversÃ£o de BAIXA (MME9 desce)
    if (mme < mme1) and (mme1 > mme2) then
    begin
      PaintBar(clRed);    // pinta candle vermelho
      Alert(clRed);
      PlotText("ðŸš¨ MME9â†“ + ADX forte + ATVâ†‘ â€” possÃ­vel short", clRed, 3, 6, High);
    end;
  end;

  // Stops â€” sÃ³ mudam cor se jÃ¡ hÃ¡ posiÃ§Ã£o (simulaÃ§Ã£o visual)
  if IsBought and (Close <= min1) then
    PaintBar(clYellow)
  else if IsSold and (Close >= max1) then
    PaintBar(clYellow);

end;
